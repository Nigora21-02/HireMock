name: EAS Build CI

# Trigger pipeline pÃ¥ push till master och pull requests
on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  # Job 1: Quality checks (snabba tester)
  quality-check:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ”§ TypeScript check
        run: npx tsc --noEmit

      - name: ğŸ¥ Run Expo doctor
        run: npx expo-doctor

      - name: ğŸ›¡ï¸ Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # Job 2: EAS Build (endast om quality check passerar)
  eas-build:
    name: ğŸš€ EAS Build
    runs-on: ubuntu-latest
    needs: quality-check # VÃ¤nta pÃ¥ quality check
    if: success() # KÃ¶r bara om fÃ¶rra jobbet lyckades

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ—ï¸ Setup EAS
        uses: expo/expo-github-action@v9
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          packager: npm

      - name: ğŸ¤– Build Android Preview
        run: eas build --platform android --profile preview --non-interactive

      - name: ğŸ“± Get Build Artifact URL
        id: build-url
        run: |
          BUILD_URL=$(eas build:list --platform android --status=finished --limit=1 --json | jq -r '.[0].artifacts.buildUrl')
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Comment Build Result
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– **EAS Build Complete!**\n\nğŸ“± [Download APK](${{ steps.build-url.outputs.build_url }})\n\nğŸ¯ Scan QR code or install on device for testing.'
            })

  # Job 3: Notifications
  notify:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [quality-check, eas-build]
    if: always() # KÃ¶r alltid, oavsett om andra jobb lyckades

    steps:
      - name: ğŸ“Š Build Status
        run: |
          echo "Quality Check: ${{ needs.quality-check.result }}"
          echo "EAS Build: ${{ needs.eas-build.result }}"
          if [[ "${{ needs.quality-check.result }}" == "success" && "${{ needs.eas-build.result }}" == "success" ]]; then
            echo "ğŸ‰ Pipeline SUCCESS!"
          else
            echo "âŒ Pipeline FAILED"
          fi
